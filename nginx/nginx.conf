events {
    worker_connections 1024;
}

http {
    map_hash_bucket_size 128;

    # API keys for each project
    map $arg_key $terra_valid {
        default 0;
        include /etc/nginx/api-keys-terra.conf;
    }

    map $arg_key $sport_valid {
        default 0;
        include /etc/nginx/api-keys-sport.conf;
    }

    map $arg_key $datashowcase_valid {
        default 0;
        include /etc/nginx/api-keys-datashowcase.conf;
    }

    map $arg_key $trialprj_valid {
        default 0;
        include /etc/nginx/api-keys-trialprj.conf;
    }

    # Combined key validation for Cipher (accepts any valid project key)
    map $arg_key $cipher_valid {
        default 0;
        include /etc/nginx/api-keys-terra.conf;
        include /etc/nginx/api-keys-sport.conf;
        include /etc/nginx/api-keys-datashowcase.conf;
        include /etc/nginx/api-keys-trialprj.conf;
    }

    server {
        listen 80;
        server_name _;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # ============================================
        # CIPHER (Direct Access - Aggregator Mode)
        # Single entry point for all memory tools
        # ============================================
        
        # SSE transport for MCP
        location = /cipher/mcp/sse {
            if ($cipher_valid = 0) { return 401; }
            rewrite ^ /mcp/sse break;
            proxy_pass http://cipher:3000;
            proxy_set_header Accept text/event-stream;
            proxy_set_header Cache-Control no-cache;
        }

        # HTTP transport for MCP
        location = /cipher/mcp {
            if ($cipher_valid = 0) { return 401; }
            rewrite ^ /mcp break;
            proxy_pass http://cipher:3000;
            proxy_set_header Content-Type application/json;
        }

        # Cipher health
        location = /cipher/health {
            rewrite ^ /health break;
            proxy_pass http://cipher:3000;
        }

        # Cipher API (for direct access)
        location /cipher/api/ {
            if ($cipher_valid = 0) { return 401; }
            rewrite ^/cipher/api/(.*)$ /api/$1 break;
            proxy_pass http://cipher:3000;
        }

        # ============================================
        # GRAPHITI (Direct Timeline Access)
        # ============================================
        location = /graphiti/mcp {
            if ($cipher_valid = 0) { return 401; }
            rewrite ^ /mcp break;
            proxy_pass http://graphiti:8000;
            proxy_set_header Content-Type application/json;
        }

        location = /graphiti/health {
            rewrite ^ /health break;
            proxy_pass http://graphiti:8000;
        }

        # ============================================
        # LEGACY: Per-Project Unified Servers
        # (Keep for backward compatibility)
        # ============================================

        # TERRA PROJECT
        location /terra/mcp {
            if ($terra_valid = 0) { return 401; }
            proxy_pass http://unified-terra:8080/mcp;
            proxy_set_header Content-Type application/json;
        }

        location /terra/health {
            proxy_pass http://unified-terra:8080/;
        }

        # SPORT PROJECT
        location /sport/mcp {
            if ($sport_valid = 0) { return 401; }
            proxy_pass http://unified-sport:8080/mcp;
            proxy_set_header Content-Type application/json;
        }

        location /sport/health {
            proxy_pass http://unified-sport:8080/;
        }

        # DATASHOWCASE PROJECT
        location /datashowcase/mcp {
            if ($datashowcase_valid = 0) { return 401; }
            proxy_pass http://unified-datashowcase:8080/mcp;
            proxy_set_header Content-Type application/json;
        }

        location /datashowcase/health {
            proxy_pass http://unified-datashowcase:8080/;
        }

        # TRIALPRJ PROJECT
        location /trialprj/mcp {
            if ($trialprj_valid = 0) { return 401; }
            proxy_pass http://unified-trialprj:8080/mcp;
            proxy_set_header Content-Type application/json;
        }

        location /trialprj/health {
            proxy_pass http://unified-trialprj:8080/;
        }

        # Root info page
        location / {
            return 200 'MCP Team Memory Server v3.1

=== RECOMMENDED: Cipher (Single Entry Point) ===
Full memory + timeline via one connection:

  SSE:  /cipher/mcp/sse?key=API_KEY
  HTTP: /cipher/mcp?key=API_KEY

17 Tools available in aggregator mode.

=== LEGACY: Per-Project Endpoints ===
  - /terra/mcp?key=API_KEY
  - /sport/mcp?key=API_KEY
  - /datashowcase/mcp?key=API_KEY
  - /trialprj/mcp?key=API_KEY

Key format: {project}_{user}_{hash}';
            add_header Content-Type text/plain;
        }
    }
}
