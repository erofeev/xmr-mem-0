events {
    worker_connections 1024;
}

http {
    map_hash_bucket_size 128;

    map $arg_key $terra_valid {
        default 0;
        include /etc/nginx/api-keys-terra.conf;
    }

    map $arg_key $sport_valid {
        default 0;
        include /etc/nginx/api-keys-sport.conf;
    }

    map $arg_key $datashowcase_valid {
        default 0;
        include /etc/nginx/api-keys-datashowcase.conf;
    }

    map $arg_key $trialprj_valid {
        default 0;
        include /etc/nginx/api-keys-trialprj.conf;
    }

    server {
        listen 80;
        server_name _;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # ============================================
        # TERRA PROJECT
        # ============================================
        location /terra/mcp {
            if ($terra_valid = 0) { return 401; }
            proxy_pass http://unified-terra:8080/mcp;
            proxy_set_header Content-Type application/json;
        }

        location /terra/health {
            proxy_pass http://unified-terra:8080/;
        }

        # ============================================
        # SPORT PROJECT
        # ============================================
        location /sport/mcp {
            if ($sport_valid = 0) { return 401; }
            proxy_pass http://unified-sport:8080/mcp;
            proxy_set_header Content-Type application/json;
        }

        location /sport/health {
            proxy_pass http://unified-sport:8080/;
        }

        # ============================================
        # DATASHOWCASE PROJECT
        # ============================================
        location /datashowcase/mcp {
            if ($datashowcase_valid = 0) { return 401; }
            proxy_pass http://unified-datashowcase:8080/mcp;
            proxy_set_header Content-Type application/json;
        }

        location /datashowcase/health {
            proxy_pass http://unified-datashowcase:8080/;
        }

        # ============================================
        # TRIALPRJ PROJECT
        # ============================================
        location /trialprj/mcp {
            if ($trialprj_valid = 0) { return 401; }
            proxy_pass http://unified-trialprj:8080/mcp;
            proxy_set_header Content-Type application/json;
        }

        location /trialprj/health {
            proxy_pass http://unified-trialprj:8080/;
        }

        # Root info page
        location / {
            return 200 'MCP Team Memory Server

Projects (HTTP transport):
- /terra/mcp?key=API_KEY
- /sport/mcp?key=API_KEY  
- /datashowcase/mcp?key=API_KEY
- /trialprj/mcp?key=API_KEY

Key format: {project}_{user}_{hash}
Example: terra_user00_abc123...';
            add_header Content-Type text/plain;
        }
    }
}
