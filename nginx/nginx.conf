events {
    worker_connections 1024;
}

http {
    map_hash_bucket_size 128;

    map $arg_key $cipher_valid {
        default 0;
        include /etc/nginx/api-keys-terra.conf;
        include /etc/nginx/api-keys-sport.conf;
        include /etc/nginx/api-keys-datashowcase.conf;
        include /etc/nginx/api-keys-trialprj.conf;
    }

    server {
        listen 80;
        server_name _;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # SSE endpoint (GET) - requires API key
        location = /cipher/mcp/sse {
            if ($cipher_valid = 0) { return 401; }
            proxy_pass http://cipher:3000;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Accept text/event-stream;
            proxy_buffering off;
            proxy_cache off;
            add_header X-Accel-Buffering no;
            chunked_transfer_encoding off;
            proxy_read_timeout 86400s;
            gzip off;
        }

        # POST endpoint - NO key check (sessionId already validated by cipher)
        location /cipher/mcp {
            proxy_pass http://cipher:3000;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering off;
            proxy_read_timeout 300s;
        }

        location /cipher/health {
            proxy_pass http://cipher:3000/health;
        }

        location /graphiti/ {
            if ($cipher_valid = 0) { return 401; }
            rewrite ^/graphiti/(.*)$ /$1 break;
            proxy_pass http://graphiti:8000;
        }

        location /terra/mcp { proxy_pass http://unified-terra:8080/mcp; }
        location /sport/mcp { proxy_pass http://unified-sport:8080/mcp; }
        location /datashowcase/mcp { proxy_pass http://unified-datashowcase:8080/mcp; }
        location /trialprj/mcp { proxy_pass http://unified-trialprj:8080/mcp; }

        location / {
            return 404 "{\"error\":\"Not found\"}";
        }
    }
}
