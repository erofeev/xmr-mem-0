events {
    worker_connections 1024;
}

http {
    map_hash_bucket_size 128;
    
    map $arg_key $terra_valid {
        default 0;
        include /etc/nginx/api-keys-terra.conf;
    }
    
    map $arg_key $sport_valid {
        default 0;
        include /etc/nginx/api-keys-sport.conf;
    }

    server {
        listen 80;
        server_name _;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # Terra HTTP Stream (with trailing slash)
        location /terra/mcp/ {
            if ($terra_valid = 0) {
                return 401;
            }
            proxy_pass http://mcp-terra:8080/mcp/;
            proxy_set_header Accept-Encoding "";
        }

        # Terra SSE
        location /terra/sse/ {
            if ($terra_valid = 0) {
                return 401;
            }
            proxy_pass http://mcp-terra:8080/sse/;
            proxy_set_header Accept-Encoding "";
            sub_filter 'data: /sse/' 'data: /terra/sse/';
            sub_filter_once off;
            sub_filter_types text/event-stream;
        }

        location /terra/sse/messages/ {
            proxy_pass http://mcp-terra:8080/sse/messages/;
            proxy_set_header Content-Type application/json;
        }

        # Sport HTTP Stream
        location /sport/mcp/ {
            if ($sport_valid = 0) {
                return 401;
            }
            proxy_pass http://mcp-sport:8080/mcp/;
            proxy_set_header Accept-Encoding "";
        }

        # Sport SSE
        location /sport/sse/ {
            if ($sport_valid = 0) {
                return 401;
            }
            proxy_pass http://mcp-sport:8080/sse/;
            proxy_set_header Accept-Encoding "";
            sub_filter 'data: /sse/' 'data: /sport/sse/';
            sub_filter_once off;
            sub_filter_types text/event-stream;
        }

        location /sport/sse/messages/ {
            proxy_pass http://mcp-sport:8080/sse/messages/;
            proxy_set_header Content-Type application/json;
        }

        location /health {
            proxy_pass http://gateway:3000/health;
        }

        location / {
            default_type application/json;
            return 404;
        }
    }
}
