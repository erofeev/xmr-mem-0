events {
    worker_connections 1024;
}

http {
    map_hash_bucket_size 128;

    # ============================================
    # API KEYS ДЛЯ КАЖДОГО ПРОЕКТА
    # ============================================

    # API ключи для Project Terra (7 разработчиков)
    map $http_x_api_key $terra_key_valid {
        default 0;
        include /etc/nginx/api-keys-terra.conf;
    }

    # API ключи для Project Sport (5 разработчиков)
    map $http_x_api_key $sport_key_valid {
        default 0;
        include /etc/nginx/api-keys-sport.conf;
    }

    limit_req_zone $http_x_api_key zone=api_limit:10m rate=10r/s;

    # ============================================
    # ОСНОВНОЙ СЕРВЕР (HTTP по IP)
    # ============================================
    server {
        listen 80;
        server_name _;

        limit_req zone=api_limit burst=20 nodelay;

        # SSE settings for MCP
        proxy_http_version 1.1;
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
        proxy_read_timeout 86400s;

        # ============================================
        # PROJECT TERRA: /terra/*
        # ============================================
        location /terra/mcp/ {
            if ($terra_key_valid = 0) {
                return 401 '{"error": "Invalid API key for Terra"}';
            }
            proxy_pass http://mcp-terra:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Project-ID terra;
        }

        location /terra/api/ {
            if ($terra_key_valid = 0) {
                return 401 '{"error": "Invalid API key for Terra"}';
            }
            proxy_pass http://mem0-terra:8000/;
            proxy_set_header Host $host;
        }

        # ============================================
        # PROJECT SPORT: /sport/*
        # ============================================
        location /sport/mcp/ {
            if ($sport_key_valid = 0) {
                return 401 '{"error": "Invalid API key for Sport"}';
            }
            proxy_pass http://mcp-sport:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Project-ID sport;
        }

        location /sport/api/ {
            if ($sport_key_valid = 0) {
                return 401 '{"error": "Invalid API key for Sport"}';
            }
            proxy_pass http://mem0-sport:8000/;
            proxy_set_header Host $host;
        }

        # ============================================
        # HEALTH CHECK (публичный)
        # ============================================
        location /health {
            return 200 '{"status": "ok", "projects": ["terra", "sport"]}';
            add_header Content-Type application/json;
        }

        location / {
            return 404 '{"error": "Use /terra/* or /sport/* endpoints"}';
            add_header Content-Type application/json;
        }
    }
}
