# MCP Team Memory v3.0 - Cipher-Centric Architecture
# Cipher (center) + Graphiti (temporal) + KB (docs)

services:
  # ==================== API GATEWAY ====================
  nginx:
    image: nginx:latest
    container_name: mcp-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/api-keys-terra.conf:/etc/nginx/api-keys-terra.conf:ro
      - ./nginx/api-keys-sport.conf:/etc/nginx/api-keys-sport.conf:ro
      - ./nginx/api-keys-datashowcase.conf:/etc/nginx/api-keys-datashowcase.conf:ro
      - ./nginx/api-keys-trialprj.conf:/etc/nginx/api-keys-trialprj.conf:ro
    networks:
      - mcp_network
    depends_on:
      cipher:
        condition: service_healthy
      graphiti:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==================== CIPHER (Memory Center) ====================
  cipher:
    build:
      context: ./cipher-src
      dockerfile: Dockerfile
    container_name: mcp-cipher
    command: sh -c "node dist/src/app/index.cjs --mode api --port 3000 --host 0.0.0.0 --agent /app/memAgent/cipher.yml --mcp-transport-type sse"
    restart: unless-stopped
    networks:
      - mcp_network
    environment:
      - NODE_ENV=production
      - MCP_SERVER_MODE=aggregator
      - USE_ASK_CIPHER=true
      - CIPHER_API_PREFIX=
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - POSTGRES_CONNECTION_STRING=postgresql://mem0:${POSTGRES_PASSWORD}@postgres:5432/cipher
      - OLLAMA_BASE_URL=http://ollama:11434
      - QDRANT_URL=http://qdrant:6333
      - HTTP_PROXY=http://172.18.0.1:10809
      - HTTPS_PROXY=http://172.18.0.1:10809
      - NO_PROXY=localhost,127.0.0.1,ollama,postgres,qdrant,graphiti,falkordb
    volumes:
      - ./cipher-src/memAgent:/app/memAgent:ro
      - cipher-data:/app/.cipher
    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G

  # ==================== UNIFIED MCP SERVERS (per-project) ====================
  unified-terra:
    build:
      context: ./unified-mcp
      dockerfile: Dockerfile
    container_name: unified-terra
    restart: unless-stopped
    networks:
      - mcp_network
    environment:
      - PYTHONUNBUFFERED=1
      - PROJECT_ID=terra
      - CIPHER_URL=http://cipher:3000
      - GRAPHITI_URL=http://graphiti:8000
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_EMBEDDING_MODEL=nomic-embed-text
      - KNOWLEDGE_BASES_ROOT=/data/knowledge_bases
      - FAISS_INDEX_DIR=/data/faiss_indexes
      - KB_CHUNK_SIZE=1000
      - KB_CHUNK_OVERLAP=200
      - LOG_LEVEL=INFO
      - HTTP_PROXY=http://172.18.0.1:10809
      - HTTPS_PROXY=http://172.18.0.1:10809
      - NO_PROXY=localhost,127.0.0.1,ollama,postgres,qdrant,graphiti,falkordb,cipher
    volumes:
      - terra-kb-data:/data/knowledge_bases
      - terra-kb-index:/data/faiss_indexes
    depends_on:
      cipher:
        condition: service_healthy
      graphiti:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M

  unified-sport:
    build:
      context: ./unified-mcp
      dockerfile: Dockerfile
    container_name: unified-sport
    restart: unless-stopped
    networks:
      - mcp_network
    environment:
      - PYTHONUNBUFFERED=1
      - PROJECT_ID=sport
      - CIPHER_URL=http://cipher:3000
      - GRAPHITI_URL=http://graphiti:8000
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_EMBEDDING_MODEL=nomic-embed-text
      - KNOWLEDGE_BASES_ROOT=/data/knowledge_bases
      - FAISS_INDEX_DIR=/data/faiss_indexes
      - KB_CHUNK_SIZE=1000
      - KB_CHUNK_OVERLAP=200
      - LOG_LEVEL=INFO
      - HTTP_PROXY=http://172.18.0.1:10809
      - HTTPS_PROXY=http://172.18.0.1:10809
      - NO_PROXY=localhost,127.0.0.1,ollama,postgres,qdrant,graphiti,falkordb,cipher
    volumes:
      - sport-kb-data:/data/knowledge_bases
      - sport-kb-index:/data/faiss_indexes
    depends_on:
      cipher:
        condition: service_healthy
      graphiti:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M

  unified-datashowcase:
    build:
      context: ./unified-mcp
      dockerfile: Dockerfile
    container_name: unified-datashowcase
    restart: unless-stopped
    networks:
      - mcp_network
    environment:
      - PYTHONUNBUFFERED=1
      - PROJECT_ID=datashowcase
      - CIPHER_URL=http://cipher:3000
      - GRAPHITI_URL=http://graphiti:8000
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_EMBEDDING_MODEL=nomic-embed-text
      - KNOWLEDGE_BASES_ROOT=/data/knowledge_bases
      - FAISS_INDEX_DIR=/data/faiss_indexes
      - KB_CHUNK_SIZE=1000
      - KB_CHUNK_OVERLAP=200
      - LOG_LEVEL=INFO
      - HTTP_PROXY=http://172.18.0.1:10809
      - HTTPS_PROXY=http://172.18.0.1:10809
      - NO_PROXY=localhost,127.0.0.1,ollama,postgres,qdrant,graphiti,falkordb,cipher
    volumes:
      - datashowcase-kb-data:/data/knowledge_bases
      - datashowcase-kb-index:/data/faiss_indexes
    depends_on:
      cipher:
        condition: service_healthy
      graphiti:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M

  unified-trialprj:
    build:
      context: ./unified-mcp
      dockerfile: Dockerfile
    container_name: unified-trialprj
    restart: unless-stopped
    networks:
      - mcp_network
    environment:
      - PYTHONUNBUFFERED=1
      - PROJECT_ID=trialprj
      - CIPHER_URL=http://cipher:3000
      - GRAPHITI_URL=http://graphiti:8000
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_EMBEDDING_MODEL=nomic-embed-text
      - KNOWLEDGE_BASES_ROOT=/data/knowledge_bases
      - FAISS_INDEX_DIR=/data/faiss_indexes
      - KB_CHUNK_SIZE=1000
      - KB_CHUNK_OVERLAP=200
      - LOG_LEVEL=INFO
      - HTTP_PROXY=http://172.18.0.1:10809
      - HTTPS_PROXY=http://172.18.0.1:10809
      - NO_PROXY=localhost,127.0.0.1,ollama,postgres,qdrant,graphiti,falkordb,cipher
    volumes:
      - trialprj-kb-data:/data/knowledge_bases
      - trialprj-kb-index:/data/faiss_indexes
    depends_on:
      cipher:
        condition: service_healthy
      graphiti:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M

  # ==================== INFRASTRUCTURE ====================
  postgres:
    image: pgvector/pgvector:pg17
    container_name: mcp-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-mem0}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=mem0
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init-v3.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - mcp_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mem0}"]
      interval: 10s
      timeout: 5s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    container_name: mcp-qdrant
    restart: unless-stopped
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - mcp_network
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G

  falkordb:
    image: falkordb/falkordb:latest
    container_name: mcp-falkordb
    restart: unless-stopped
    volumes:
      - falkordb-data:/data
    networks:
      - mcp_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G

  ollama:
    image: ollama/ollama:latest
    container_name: mcp-ollama
    restart: unless-stopped
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - mcp_network
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G

  graphiti:
    build:
      context: ./graphiti-custom
      dockerfile: Dockerfile
    container_name: graphiti
    restart: unless-stopped
    networks:
      - mcp_network
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LLM_PROVIDER=anthropic
      - LLM_MODEL=claude-3-5-haiku-20241022
      - EMBEDDER_PROVIDER=openai
      - OPENAI_API_KEY=ollama-key
      - OPENAI_BASE_URL=http://ollama:11434/v1
      - FALKORDB_URI=redis://falkordb:6379
      - FALKORDB_HOST=falkordb
      - FALKORDB_PORT=6379
      - FALKORDB_DATABASE=graphiti
      - EMBEDDING_MODEL=nomic-embed-text
      - OLLAMA_BASE_URL=http://ollama:11434
      - HTTP_PROXY=http://172.18.0.1:10809
      - HTTPS_PROXY=http://172.18.0.1:10809
      - NO_PROXY=localhost,127.0.0.1,ollama,falkordb
    volumes:
      - ./graphiti/config.yaml:/app/mcp/config.yaml:ro
    depends_on:
      falkordb:
        condition: service_healthy
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 768M

networks:
  mcp_network:
    driver: bridge

volumes:
  postgres-data:
  qdrant-data:
  falkordb-data:
  ollama-data:
  cipher-data:
  terra-kb-data:
  terra-kb-index:
  sport-kb-data:
  sport-kb-index:
  datashowcase-kb-data:
  datashowcase-kb-index:
  trialprj-kb-data:
  trialprj-kb-index:
